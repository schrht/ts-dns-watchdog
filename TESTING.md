# Testing Guide

This document explains how to test the Tailscale DNS Watchdog script.

## Prerequisites

1. Tailscale installed and logged in
2. `jq` installed
3. Root privileges

## Testing Steps

### 1. Verify Dependencies

```bash
# Check tailscale command
tailscale --version

# Check jq command
jq --version

# Check tailscale status (should return JSON)
tailscale status --json | jq .
```

### 2. Verify Tailscale State

```bash
# Check BackendState (should be "Running")
tailscale status --json | jq -r '.BackendState'

# Check Health (see if there's DNS fight)
tailscale status --json | jq -r '.Health'
```

### 3. Manual Function Testing (Requires Root)

```bash
# Change to script directory
cd /path/to/ts-watchdog

# Source script to load functions
sudo bash -c 'source ts-dns-watchdog.sh; get_tailscale_status | jq .'

# Test state determination
sudo bash -c 'source ts-dns-watchdog.sh; is_tailscale_running && echo "Running" || echo "Not Running"'

# Test DNS fight detection
sudo bash -c 'source ts-dns-watchdog.sh; has_dns_fight && echo "DNS fight detected" || echo "No DNS fight"'

# Test resolv.conf identification
sudo bash -c 'source ts-dns-watchdog.sh; is_tailscale_resolv && echo "Tailscale resolv.conf" || echo "Not Tailscale resolv.conf"'
```

### 4. Test Backup Functionality

```bash
# Ensure Tailscale is Running and no DNS fight
tailscale status --json | jq '{BackendState, Health}'

# Run backup function
sudo bash -c 'source ts-dns-watchdog.sh; backup_resolv_conf'

# Check backup file
sudo cat /etc/resolv.conf.tailscale.backup
```

### 5. Simulate DNS Fight (Advanced Testing)

⚠️ **Warning**: This test modifies system DNS configuration, proceed with caution.

```bash
# Backup current resolv.conf (manual backup, not script backup)
sudo cp /etc/resolv.conf /tmp/resolv.conf.backup

# Modify resolv.conf, add conflicting DNS server
sudo sh -c 'echo "nameserver 8.8.8.8" > /etc/resolv.conf'

# Wait for Tailscale to detect DNS fight (may take a few seconds)
sleep 5

# Check if DNS fight is detected
tailscale status --json | jq -r '.Health' | grep -i "System DNS config not ideal"

# If detected, run script to fix
sudo bash ts-dns-watchdog.sh &
WATCHDOG_PID=$!

# Wait a few seconds for script to detect and fix
sleep 10

# Stop script
sudo kill $WATCHDOG_PID

# Check fix result
tailscale status --json | jq -r '.Health'

# Restore original configuration (if needed)
sudo cp /tmp/resolv.conf.backup /etc/resolv.conf
```

### 6. Test systemd Service

```bash
# Install service file
sudo cp ts-dns-watchdog.service /etc/systemd/system/
sudo cp ts-dns-watchdog.sh /usr/local/bin/
sudo chmod +x /usr/local/bin/ts-dns-watchdog.sh

# Reload systemd
sudo systemctl daemon-reload

# Start service
sudo systemctl start ts-dns-watchdog.service

# Check service status
sudo systemctl status ts-dns-watchdog.service

# View logs
sudo journalctl -u ts-dns-watchdog.service -f

# Stop service
sudo systemctl stop ts-dns-watchdog.service
```

## Expected Behavior

### Normal Case (No DNS Fight)

- Script checks every 30 seconds
- If conditions are met, backup is generated/updated
- Log shows "No DNS fight detected, system healthy"

### DNS Fight Detected

1. Log shows "DNS fight detected: System DNS config not ideal"
2. Attempt soft fix (if backup exists)
3. If soft fix succeeds, log shows "Soft fix successful"
4. If soft fix fails, attempt hard fix (restart tailscaled)
5. After hard fix, log shows fix result

### Tailscale Not Running

- Log shows "Tailscale not Running, skipping check"
- No operations performed (no backup, no fix, no restart)

## Troubleshooting

### Script Cannot Get Tailscale Status

```bash
# Check if tailscale command is available
which tailscale

# Check if logged in
tailscale status

# Manually test JSON output
tailscale status --json
```

### jq Parsing Failed

```bash
# Check if jq is installed
which jq

# Test JSON parsing
tailscale status --json | jq .
```

### Permission Issues

```bash
# Check script permissions
ls -l ts-dns-watchdog.sh

# Check if running as root
sudo id

# Test file write permissions
sudo touch /etc/resolv.conf.tailscale.backup
```

### Backup Not Generated

Check if all conditions are met:

```bash
# 1. Tailscale Running?
tailscale status --json | jq -r '.BackendState'

# 2. No DNS fight?
tailscale status --json | jq -r '.Health' | grep -i "System DNS config not ideal" && echo "DNS fight!" || echo "No DNS fight"

# 3. resolv.conf is Tailscale-generated?
grep -i "file generated by tailscale" /etc/resolv.conf && echo "Tailscale resolv.conf" || echo "Not Tailscale resolv.conf"
```

## Security Testing

### Test Behavior When tailscale down

```bash
# Stop Tailscale
sudo tailscale down

# Run script (should skip all operations)
sudo bash ts-dns-watchdog.sh &
WATCHDOG_PID=$!

# Wait a few seconds
sleep 5

# Check logs (should see "Tailscale not Running, skipping check")
sudo journalctl -u ts-dns-watchdog.service -n 10

# Stop script
sudo kill $WATCHDOG_PID

# Restore Tailscale
sudo tailscale up
```

## Performance Testing

### Check Resource Usage

```bash
# View process resource usage
ps aux | grep ts-dns-watchdog

# View memory usage
pmap -x $(pgrep -f ts-dns-watchdog)
```

The script should be very lightweight, executing only a few commands at check intervals.
